{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/home.css' %}">
</head>
<body>
    <h1>오늘 {{user.name}}님에게 온 문안 메시지</h1>
    
    <div>
        {% comment %}메시지 받은 내용{% endcomment %}
        <ul>
            {% for message in received_messages %}
                <li>{{ message.sender }} : 
                    {% if message.recommendContent and message.recommendContent != 'custom' %}
                        {{ message.get_recommendContent_display }}
                    {% elif message.customContent %}
                        {{ message.customContent }}
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    </div>

    <h1>누구에게 문안인사를 해볼까요?</h1>
    <div id="send-letter">
        <div id="connected-accounts">
            <ul>
                {% for account in connected_users %}
                    <li class="account-item" data-id="{{ account.other_user.id }}">{{ account.other_user.name }} (관계: {{ account.relationship }})</li>
                {% empty %}
                    <li>연결된 계정이 없습니다.</li>
                {% endfor %}
            </ul>
        </div>
        <a href="{% url 'accounts:connection' %}">계정 더 연결하기</a>
        <h3>클릭 한번으로 보내는 오늘의 문안인사!</h3>

        <div>
        <select id="recommendContentSelect">
            {% for choice in recommendContent_choices %}
                <option value="{{ choice.0 }}">{{ choice.1 }}</option>
            {% endfor %}
            <option value="custom">직접입력하세요</option>
        </select>
        <div>
        <div id="customInputContainer" style="display: none;">
            <input type="text" id="customContentInput" placeholder="직접 입력하세요">
        </div>

        <input type="submit" class="sendMessage-btn" id="sendMessageButton" value="전송하기">  

            {% csrf_token %}
        <h1>간단하게 표시하는 나의 건강한 일상</h1>
        <div>
            <p>약 영양제 챙겨먹기 <button class="status-button" id="medButton">챙겨먹었어요</button></p>
            {% for user_medication in user_medications %}
                <p value="{{ user_medication.medication }}">{{ user_medication }}</p>
            {% endfor %}
        </div>
            {% csrf_token %}
        <div>
            {% for user_nutrition in user_nutritions %}
                <p value="{{ user_nutrition.nutrition }}">{{ user_nutrition }}</p>
            {% endfor %}
            <p>운동하기 <button class="status-button" id="exerciseButton">했어요</button></p>
            <p>산책하기 외출하기 간단한 체조</p>
        </div>
        
    </div>

    <br>
    <a href="{% url 'home' %}">홈</a>
    <a href="{% url 'locker' %}">보관함</a>
    <a href="{% url 'alarm' %}">알림</a>

    <div id="myModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p>문안인사가 성공적으로 전송되었습니다!</p>
        </div>
    </div>
    
</body>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // 사용자 클릭 이벤트 핸들러 함수
    function handleAccountItemClick(event) {
        const accountId = event.currentTarget.getAttribute('data-id');
        const sendMessageButton = document.querySelector('#sendMessageButton');
        
        // 기존에 활성화된 계정 아이템의 active 클래스 제거
        const activeAccountItem = document.querySelector('.account-item.active');
        if (activeAccountItem) {
            activeAccountItem.classList.remove('active');
        }
        
        // 현재 클릭한 계정 아이템에 active 클래스 추가
        event.currentTarget.classList.add('active');
        
        sendMessageButton.setAttribute('data-account-id', accountId);
    }

    // 사용자 클릭 이벤트 핸들러 추가
    const accountItems = document.querySelectorAll('.account-item');
    accountItems.forEach(item => {
        item.addEventListener('click', handleAccountItemClick);
    });

    //직접 입력
    const recommendContentSelect = document.querySelector('#recommendContentSelect');
    const customInputContainer = document.querySelector('#customInputContainer');
    const customContentInput = document.querySelector('#customContentInput');

    recommendContentSelect.addEventListener('change', function() {
        const selectedValue = this.value;
        if (selectedValue === 'custom') {
            customInputContainer.style.display = 'block';
        } else {
            customInputContainer.style.display = 'none';
        }
    });

    //메시지 전송 
    document.querySelector('#sendMessageButton').addEventListener('click', function () {
        const selectedAccountId = this.getAttribute('data-account-id');
        const selectedRecommendContent = document.querySelector('#recommendContentSelect').value;
        const customContent = document.querySelector('#customContentInput').value;

        $.ajax({
            type: 'POST',
            url: /send_message/,
            data: {'receiver_id' : selectedAccountId, 'recommendContent' : selectedRecommendContent, 'customContent' : customContent, 'csrfmiddlewaretoken': '{{csrf_token}}'},
            dataType: 'json',
            success: function(response) {
                // Ajax 요청이 성공하면 여기서 화면 업데이트를 수행합니다.
                if (response.success) { 
                    showModal(response.message); 
                }else{
                    showModal(response.message); 
                }
            },
            error: function(xhr, status, error) {
                console.error(error);
            }
        });
    
    });

    function showModal(message) {
        // 모달창
        var modal = document.getElementById("myModal");
        var modalContent = modal.querySelector('.modal-content');
        var span = modal.querySelector('.close');
        var modalParagraph = modalContent.querySelector('p');
        
        modalParagraph.textContent = message;
        modal.style.display = "block";
    
        // 모달 닫기
        span.onclick = function() {
            modal.style.display = "none";
        }
    
        // 모달 이외의 영역을 클릭하면 모달 닫기
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    }

    $(document).ready(function () {
    var csrfToken = getCookie('csrftoken'); // 한 번만 토큰을 가져옴

    // 약/영양제 먹었는지 버튼
    var takeMedButton = document.getElementById('medButton');
    var isMedTaken = false; // 초기값 설정

    takeMedButton.addEventListener('click', function () {
        isMedTaken = !isMedTaken; // 값을 토글
        var actionType = 'medication'; // actionType 변수를 정의
        var isMedicationTaken = !$(this).hasClass('taken');
        updateStatus('medication', isMedicationTaken, csrfToken); // 토큰 사용
        // 버튼 색 변경
        if (isMedicationTaken) {
            $(this).addClass('taken');
            $(this).css('background-color', '#FF003A');
        } else {
            $(this).removeClass('taken');
            $(this).css('background-color', ''); // 원래 색상으로 변경
        }
    });

    // 운동했는지 버튼
    var takeExerciseButton = document.getElementById('exerciseButton');
    var isExerciseTaken = false; // 초기값 설정

    takeExerciseButton.addEventListener('click', function () {
        var actionType = 'exercise'; // actionType 변수를 정의
        var hasExercised = !$(this).hasClass('taken');
        updateStatus('exercise', hasExercised, csrfToken); // 토큰 사용
        isExerciseTaken = !isExerciseTaken; // 값을 토글
        // 버튼 색 변경
        if (isExerciseTaken) {
            $(this).addClass('taken');
            $(this).css('background-color', '#FF003A');
        } else {
            $(this).removeClass('taken');
            $(this).css('background-color', ''); // 원래 색상으로 변경
        }
    });

    // getCookie 함수 정의
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateStatus(actionType, status, csrfToken) {
        $.ajax({
            url: '/daily_status/',
            type: 'POST',
            data: { actionType: actionType, status: status },
            headers: { "X-CSRFToken": csrfToken },
            success: function (data) {
                // 서버 응답 처리
                if (data.status === 'success') {
                    // 버튼 상태 업데이트
                    if (actionType === 'medication') {
                        $('#medication-button').toggleClass('taken', status);
                    } else if (actionType === 'exercise') {
                        $('#exercise-button').toggleClass('taken', status);
                    }
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                // 에러 처리
            }
        });
    }
});



// $(document).ready(function () {
//     var csrfToken = getCookie('csrftoken');

//     // 약을 먹었는지 버튼 처리
//     $('#medButton').click(function () {
//         var isMedicationTaken = !$(this).hasClass('taken');
//         updateStatus('medication', isMedicationTaken, csrfToken);
//     });

//     // 운동했는지 버튼 처리
//     $('#exerciseButton').click(function () {
//         var hasExercised = !$(this).hasClass('taken');
//         updateStatus('exercise', hasExercised, csrfToken);
//     });

//     function getCookie(name) {
//         var cookieValue = null;
//         if (document.cookie && document.cookie !== '') {
//             var cookies = document.cookie.split(';');
//             for (var i = 0; i < cookies.length; i++) {
//                 var cookie = cookies[i].trim();
//                 if (cookie.substring(0, name.length + 1) === (name + '=')) {
//                     cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
//                     break;
//                 }
//             }
//         }
//         return cookieValue;
//     }

//     function updateStatus(actionType, status, csrfToken) {
//         $.ajax({
//             url: '/daily_status/',
//             type: 'POST',
//             data: { actionType: actionType, status: status },
//             headers: { "X-CSRFToken": csrfToken },
//             success: function (data) {
//                 // 서버 응답 처리
//                 if (data.status === 'success') {
//                     // 버튼 상태 업데이트
//                     if (actionType === 'medication') {
//                         $('#medication-button').toggleClass('taken', status);
//                         if (status) {
//                             $('#medButton').css('background-color', '#FF003A');
//                         } else {
//                             $('#medButton').css('background-color', ''); // 원래 색상으로 변경
//                         }
//                     } else if (actionType === 'exercise') {
//                         $('#exerciseButton').toggleClass('taken', status);
//                         if (status) {
//                             $('#exerciseButton').css('background-color', '#FF003A');
//                         } else {
//                             $('#exerciseButton').css('background-color', ''); // 원래 색상으로 변경
//                         }
//                     }
//                 }
//             },
//             error: function (xhr, textStatus, errorThrown) {
//                 // 에러 처리
//             }
//         });
//     }

//     // getCookie 함수 정의 (이하 동일)
    
// });


</script>


</html>